<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ù§Ô∏è</text></svg>">
<title>Shred the Slopes üèÇ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Nunito:wght@700;900&display=swap');

  :root {
    --snow-white: #eaf2fb;
    --sky-top: #4a90d9;
    --sky-bottom: #b8d8f8;
    --pine-green: #1a5c2a;
    --valentine-pink: #e84393;
    --valentine-red: #d63031;
    --gold: #fdcb6e;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%;
    height: 100dvh;
    background: #1a1a2e;
    font-family: 'Nunito', sans-serif;
    overflow: hidden;
  }

  body {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #game-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    max-width: min(480px, 100vw);
    max-height: min(720px, 100dvh);
    aspect-ratio: 2 / 3;
  }

  canvas {
    display: block;
    width: 100%;
    height: 100%;
    touch-action: none;
  }

  /* Only add flair on larger screens where there's room */
  @media (min-width: 520px) and (min-height: 760px) {
    canvas {
      border-radius: 12px;
      box-shadow: 0 0 60px rgba(232, 67, 147, 0.3), 0 8px 32px rgba(0,0,0,0.5);
    }
  }

  #start-screen {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(180deg, var(--sky-top), var(--sky-bottom) 40%, var(--snow-white) 60%);
    border-radius: 12px;
    z-index: 10;
    text-align: center;
  }

  #start-screen h1 {
    font-family: 'Bangers', cursive;
    font-size: 52px;
    color: var(--valentine-pink);
    text-shadow: 3px 3px 0 var(--valentine-red), 0 0 20px rgba(232,67,147,0.4);
    letter-spacing: 3px;
    margin-bottom: 8px;
  }

  #start-screen p {
    color: #555;
    font-size: 15px;
    margin-bottom: 32px;
    font-weight: 700;
  }

  #start-btn {
    font-family: 'Bangers', cursive;
    font-size: 28px;
    letter-spacing: 2px;
    padding: 14px 48px;
    background: var(--valentine-pink);
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 6px 0 var(--valentine-red), 0 8px 20px rgba(232,67,147,0.4);
    transition: transform 0.1s, box-shadow 0.1s;
  }

  #start-btn:hover {
    transform: translateY(2px);
    box-shadow: 0 4px 0 var(--valentine-red), 0 6px 14px rgba(232,67,147,0.4);
  }

  #start-btn:active {
    transform: translateY(4px);
    box-shadow: 0 2px 0 var(--valentine-red), 0 2px 8px rgba(232,67,147,0.4);
  }

  .snowflake-bg {
    position: absolute;
    color: white;
    opacity: 0.6;
    font-size: 20px;
    animation: snowfall linear infinite;
    pointer-events: none;
  }

  @keyframes snowfall {
    to { transform: translateY(720px) rotate(360deg); }
  }

  #overlay {
    position: absolute;
    inset: 0;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0,0,0,0.7);
    border-radius: 12px;
    z-index: 20;
    text-align: center;
    padding: 40px;
  }

  #overlay.visible { display: flex; }

  #overlay h2 {
    font-family: 'Bangers', cursive;
    font-size: 36px;
    color: var(--valentine-pink);
    margin-bottom: 16px;
    text-shadow: 0 0 20px rgba(232,67,147,0.6);
  }

  #overlay p {
    color: var(--snow-white);
    font-size: 18px;
    font-weight: 700;
    line-height: 1.6;
  }

  .instructions {
    color: #888;
    font-size: 12px;
    margin-top: 16px;
    font-weight: 700;
  }
</style>
</head>
<body>

<div id="game-wrapper">
  <canvas id="game" width="480" height="720"></canvas>

  <div id="start-screen">
    <h1>üèÇ SHRED RUN üèÇ</h1>
    <p>Shred the gnar & dodge obstacles to reach the bottom</p>
    <button id="start-btn">DROP IN!</button>
    <div class="instructions">‚Üê ‚Üí Arrow keys or touch to steer</div>
  </div>

  <div id="overlay">
    <h2 id="overlay-title"></h2>
    <p id="overlay-text"></p>
  </div>
</div>

<script>
// ============================================================
// SHRED RUN ‚Äî Valentine's Snowboard Mini-game
// ============================================================
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = 480, H = 720;

const startScreen = document.getElementById('start-screen');
const startBtn = document.getElementById('start-btn');
const overlay = document.getElementById('overlay');
const overlayTitle = document.getElementById('overlay-title');
const overlayText = document.getElementById('overlay-text');

// --- Game State ---
let state = 'menu'; // menu | playing | question | yes | no | lift
let scrollY = 0;
const TOTAL_SLOPE_LENGTH = 6000;
const QUESTION_ZONE = TOTAL_SLOPE_LENGTH - 600;

let player = {};
let obstacles = [];
let particles = [];
let snowflakes = [];
let keys = {};
let crashTimer = 0;
let health = 3;
let liftY = 0;
let liftPhase = 0;
let hearts = [];
let noCount = 0;

// --- Input ---
window.addEventListener('keydown', e => {
  keys[e.key] = true;
  if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) e.preventDefault();
});
window.addEventListener('keyup', e => keys[e.key] = false);

// --- Touch Input ---
let touchActive = false;
let touchDX = 0; // analog touch offset from player
let touchDY = 0;

function getTouchPos(e) {
  let touch = e.touches[0] || e.changedTouches[0];
  if (!touch) return null;
  let rect = canvas.getBoundingClientRect();
  return {
    x: (touch.clientX - rect.left) / rect.width * W,
    y: (touch.clientY - rect.top) / rect.height * H
  };
}

canvas.addEventListener('touchstart', e => {
  if (state === 'menu') return;
  e.preventDefault();
  touchActive = true;
  let pos = getTouchPos(e);
  if (!pos) return;
  updateTouchAnalog(pos);
  // Tap detection for choosing state ‚Äî check if tapping a gate
  if (state === 'choosing') {
    let gateScreenY = (QUESTION_ZONE - scrollY) + 240;
    if (pos.y > gateScreenY && pos.y < gateScreenY + 60) {
      if (pos.x > 40 && pos.x < 200) {
        state = 'yes';
        spawnHearts(W / 2, H / 2);
        showYes();
        return;
      } else if (pos.x > 280 && pos.x < 440) {
        state = 'no';
        showNo();
        return;
      }
    }
  }
}, { passive: false });

canvas.addEventListener('touchmove', e => {
  if (state === 'menu') return;
  e.preventDefault();
  if (!touchActive) return;
  let pos = getTouchPos(e);
  if (!pos) return;
  updateTouchAnalog(pos);
}, { passive: false });

canvas.addEventListener('touchend', e => {
  if (state === 'menu') return;
  e.preventDefault();
  touchActive = false;
  touchDX = 0;
  touchDY = 0;
}, { passive: false });

function updateTouchAnalog(pos) {
  if (player.x == null) return;
  touchDX = pos.x - player.x;
  touchDY = pos.y - player.y;
}

// --- Device detection ---
let isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

// --- Responsive sizing handled by CSS ---

// --- Start ---
startBtn.addEventListener('click', () => {
  startScreen.style.display = 'none';
  initGame();
});

function initGame() {
  state = 'playing';
  scrollY = 0;
  crashTimer = 0;
  health = 3;
  player = { x: W / 2, y: 200, vx: 0, speed: 0, maxSpeed: 3.8, tilt: 0, trail: [] };
  obstacles = [];
  particles = [];
  hearts = [];
  generateObstacles();
  generateSnowflakes();
  overlay.classList.remove('visible');
  requestAnimationFrame(gameLoop);
}

function generateObstacles() {
  obstacles = [];
  // Trees and small skiers spread across the slope
  for (let y = 400; y < QUESTION_ZONE - 200; y += 45) {
    // 1-3 obstacles per row band
    let count = Math.random() < 0.3 ? 2 : 1;
    if (Math.random() < 0.1) count = 3;
    for (let i = 0; i < count; i++) {
      let ox = 40 + Math.random() * (W - 80);
      let r = Math.random();
      let type = r < 0.55 ? 'tree' : r < 0.8 ? 'skier' : 'rock';
      obstacles.push({ x: ox, y: y + Math.random() * 40, type, hit: false });
    }
  }
}

function generateSnowflakes() {
  snowflakes = [];
  for (let i = 0; i < 80; i++) {
    snowflakes.push({
      x: Math.random() * W,
      y: Math.random() * H,
      r: 1 + Math.random() * 2.5,
      speed: 0.5 + Math.random() * 1.5,
      drift: (Math.random() - 0.5) * 0.5
    });
  }
}

const var_pink = '#e84393';

// --- Drawing Helpers ---
function drawTree(x, y) {
  // Trunk
  ctx.fillStyle = '#5d4037';
  ctx.fillRect(x - 4, y + 10, 8, 14);
  // Layers of pine
  ctx.fillStyle = '#1a5c2a';
  ctx.beginPath(); ctx.moveTo(x, y - 28); ctx.lineTo(x - 18, y); ctx.lineTo(x + 18, y); ctx.fill();
  ctx.fillStyle = '#1e6e32';
  ctx.beginPath(); ctx.moveTo(x, y - 20); ctx.lineTo(x - 14, y + 4); ctx.lineTo(x + 14, y + 4); ctx.fill();
  ctx.fillStyle = '#22803a';
  ctx.beginPath(); ctx.moveTo(x, y - 12); ctx.lineTo(x - 10, y + 10); ctx.lineTo(x + 10, y + 10); ctx.fill();
  // Snow cap
  ctx.fillStyle = '#e8f0fa';
  ctx.beginPath(); ctx.moveTo(x, y - 28); ctx.lineTo(x - 8, y - 16); ctx.lineTo(x + 8, y - 16); ctx.fill();
}

function drawSkier(x, y) {
  // Small child skier in proper ski stance
  ctx.save();
  ctx.translate(x, y);

  // Skis ‚Äî long, flat, parallel, with curved tips
  ctx.fillStyle = '#d35400';
  // Left ski
  ctx.beginPath();
  ctx.moveTo(-7, 18); ctx.lineTo(-7, 8); ctx.quadraticCurveTo(-7, 4, -5, 2);
  ctx.lineTo(-3, 2); ctx.quadraticCurveTo(-3, 4, -3, 8); ctx.lineTo(-3, 18);
  ctx.closePath(); ctx.fill();
  // Right ski
  ctx.beginPath();
  ctx.moveTo(3, 18); ctx.lineTo(3, 8); ctx.quadraticCurveTo(3, 4, 5, 2);
  ctx.lineTo(7, 2); ctx.quadraticCurveTo(7, 4, 7, 8); ctx.lineTo(7, 18);
  ctx.closePath(); ctx.fill();

  // Boots
  ctx.fillStyle = '#2c3e50';
  ctx.fillRect(-8, 8, 6, 5);
  ctx.fillRect(2, 8, 6, 5);

  // Legs ‚Äî ski pants, slightly bent at knees
  ctx.fillStyle = '#2980b9';
  ctx.beginPath();
  ctx.moveTo(-7, 8); ctx.lineTo(-6, -2); ctx.lineTo(-2, -2); ctx.lineTo(-3, 8);
  ctx.closePath(); ctx.fill();
  ctx.beginPath();
  ctx.moveTo(3, 8); ctx.lineTo(2, -2); ctx.lineTo(6, -2); ctx.lineTo(7, 8);
  ctx.closePath(); ctx.fill();

  // Torso ‚Äî puffy ski jacket
  ctx.fillStyle = '#e74c3c';
  ctx.beginPath();
  ctx.moveTo(-8, -2);
  ctx.lineTo(-9, -14);
  ctx.quadraticCurveTo(-9, -16, -7, -16);
  ctx.lineTo(7, -16);
  ctx.quadraticCurveTo(9, -16, 9, -14);
  ctx.lineTo(8, -2);
  ctx.closePath();
  ctx.fill();
  // Jacket zipper
  ctx.strokeStyle = '#c0392b';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(0, -15); ctx.lineTo(0, -2); ctx.stroke();

  // Arms ‚Äî bent, holding poles
  ctx.fillStyle = '#e74c3c';
  // Left arm
  ctx.beginPath();
  ctx.moveTo(-8, -14); ctx.lineTo(-14, -8); ctx.lineTo(-15, -4);
  ctx.lineTo(-12, -4); ctx.lineTo(-11, -7); ctx.lineTo(-6, -12);
  ctx.closePath(); ctx.fill();
  // Right arm
  ctx.beginPath();
  ctx.moveTo(8, -14); ctx.lineTo(14, -8); ctx.lineTo(15, -4);
  ctx.lineTo(12, -4); ctx.lineTo(11, -7); ctx.lineTo(6, -12);
  ctx.closePath(); ctx.fill();

  // Gloves
  ctx.fillStyle = '#1a1a1a';
  ctx.beginPath(); ctx.arc(-14, -3, 2.5, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(14, -3, 2.5, 0, Math.PI * 2); ctx.fill();

  // Poles ‚Äî angled back from hands
  ctx.strokeStyle = '#b0b0b0';
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(-14, -3); ctx.lineTo(-10, 16); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(14, -3); ctx.lineTo(10, 16); ctx.stroke();
  // Pole baskets (little circles near bottom)
  ctx.strokeStyle = '#999';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.arc(-10, 14, 2.5, 0, Math.PI * 2); ctx.stroke();
  ctx.beginPath(); ctx.arc(10, 14, 2.5, 0, Math.PI * 2); ctx.stroke();

  // Neck gaiter
  ctx.fillStyle = '#c0392b';
  ctx.fillRect(-5, -19, 10, 4);

  // Head
  ctx.fillStyle = '#ffeaa7';
  ctx.beginPath(); ctx.arc(0, -22, 6, 0, Math.PI * 2); ctx.fill();

  // Helmet
  ctx.fillStyle = '#2980b9';
  ctx.beginPath(); ctx.arc(0, -24, 7, Math.PI, 0); ctx.fill();
  ctx.fillRect(-7, -24, 14, 4);

  // Goggles
  ctx.fillStyle = '#f39c12';
  ctx.fillRect(-5, -24, 4, 3);
  ctx.fillRect(1, -24, 4, 3);
  // Goggle lens shine
  ctx.fillStyle = '#f1c40f';
  ctx.fillRect(-4, -23.5, 1.5, 1.5);
  ctx.fillRect(2, -23.5, 1.5, 1.5);

  ctx.restore();
}

function drawRock(x, y) {
  // Main rock body
  ctx.fillStyle = '#7f8c8d';
  ctx.beginPath();
  ctx.moveTo(x - 14, y + 8);
  ctx.lineTo(x - 12, y - 4);
  ctx.lineTo(x - 4, y - 10);
  ctx.lineTo(x + 6, y - 8);
  ctx.lineTo(x + 13, y - 2);
  ctx.lineTo(x + 14, y + 8);
  ctx.closePath();
  ctx.fill();
  // Highlight
  ctx.fillStyle = '#95a5a6';
  ctx.beginPath();
  ctx.moveTo(x - 8, y - 2);
  ctx.lineTo(x - 2, y - 8);
  ctx.lineTo(x + 5, y - 6);
  ctx.lineTo(x + 2, y);
  ctx.closePath();
  ctx.fill();
  // Snow on top
  ctx.fillStyle = '#e8f0fa';
  ctx.beginPath();
  ctx.moveTo(x - 10, y - 3);
  ctx.quadraticCurveTo(x - 4, y - 12, x + 4, y - 9);
  ctx.quadraticCurveTo(x + 10, y - 6, x + 12, y - 1);
  ctx.quadraticCurveTo(x + 6, y - 5, x, y - 6);
  ctx.quadraticCurveTo(x - 6, y - 5, x - 10, y - 3);
  ctx.fill();
}

function drawPlayer(x, y, tilt) {
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(tilt * 0.15);

  // Snowboard ‚Äî sideways stance, board perpendicular to direction
  ctx.save();
  ctx.rotate(tilt * 0.1); // board edges with tilt
  // Board base
  ctx.fillStyle = '#2d3436';
  ctx.beginPath();
  ctx.moveTo(-18, 14);   // left tip
  ctx.quadraticCurveTo(-22, 16, -18, 18); // left rounded nose
  ctx.lineTo(18, 18);
  ctx.quadraticCurveTo(22, 16, 18, 14);   // right rounded tail
  ctx.lineTo(-18, 14);
  ctx.fill();
  // Board top color
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(-16, 14.5, 32, 3);
  // Center stripe
  ctx.strokeStyle = var_pink;
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(-14, 16); ctx.lineTo(14, 16); ctx.stroke();
  // Bindings
  ctx.fillStyle = '#444';
  ctx.fillRect(-8, 13.5, 5, 5);
  ctx.fillRect(3, 13.5, 5, 5);
  ctx.restore();

  // Legs (brown pants) ‚Äî sideways snowboard stance
  ctx.fillStyle = '#6d4c28';
  ctx.fillRect(-5, 4, 5, 12);
  ctx.fillRect(2, 4, 5, 12);

  // Torso (purple jacket)
  ctx.fillStyle = '#0d9488';
  ctx.fillRect(-8, -8, 16, 14);
  // Jacket detail
  ctx.fillStyle = '#14b8a6';
  ctx.fillRect(-6, -6, 12, 10);
  // Zipper
  ctx.strokeStyle = '#d5d8dc';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(0, -6); ctx.lineTo(0, 5); ctx.stroke();

  // Arms
  ctx.fillStyle = '#0d9488';
  ctx.save();
  ctx.rotate(-0.3 + tilt * 0.1);
  ctx.fillRect(-14, -6, 7, 4);
  ctx.restore();
  ctx.save();
  ctx.rotate(0.3 - tilt * 0.1);
  ctx.fillRect(7, -6, 7, 4);
  ctx.restore();

  // Head
  ctx.fillStyle = '#ffeaa7';
  ctx.beginPath(); ctx.arc(0, -14, 7, 0, Math.PI * 2); ctx.fill();

  // Green helmet
  ctx.fillStyle = '#27ae60';
  ctx.beginPath(); ctx.arc(0, -16, 8, Math.PI, 0); ctx.fill();
  ctx.fillRect(-8, -16, 16, 3);
  // Goggle strap
  ctx.fillStyle = '#1e8449';
  ctx.fillRect(-7, -14, 14, 2);
  // Goggles
  ctx.fillStyle = '#f39c12';
  ctx.fillRect(-5, -14, 4, 3);
  ctx.fillRect(1, -14, 4, 3);
  ctx.fillStyle = '#e67e22';
  ctx.fillRect(-4, -13, 2, 1);
  ctx.fillRect(2, -13, 2, 1);

  ctx.restore();
}

// --- Snow spray particles ---
function spawnSpray(x, y, dir) {
  for (let i = 0; i < 3; i++) {
    particles.push({
      x, y: y + 10,
      vx: dir * (1 + Math.random() * 2),
      vy: -(Math.random() * 2),
      life: 15 + Math.random() * 10,
      maxLife: 25,
      r: 2 + Math.random() * 2
    });
  }
}

function spawnCrash(x, y) {
  for (let i = 0; i < 20; i++) {
    let angle = Math.random() * Math.PI * 2;
    let speed = 2 + Math.random() * 4;
    particles.push({
      x, y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      life: 20 + Math.random() * 20,
      maxLife: 40,
      r: 2 + Math.random() * 3
    });
  }
}

function spawnHearts(x, y) {
  for (let i = 0; i < 30; i++) {
    hearts.push({
      x: x + (Math.random() - 0.5) * 200,
      y: y + (Math.random() - 0.5) * 100,
      vy: -(1 + Math.random() * 3),
      vx: (Math.random() - 0.5) * 2,
      size: 10 + Math.random() * 20,
      life: 120 + Math.random() * 60,
      rot: Math.random() * 0.5 - 0.25
    });
  }
}

function drawHeart(x, y, size, alpha) {
  ctx.save();
  ctx.globalAlpha = alpha;
  ctx.fillStyle = var_pink;
  ctx.beginPath();
  ctx.moveTo(x, y + size * 0.3);
  ctx.bezierCurveTo(x, y, x - size / 2, y, x - size / 2, y + size * 0.3);
  ctx.bezierCurveTo(x - size / 2, y + size * 0.6, x, y + size * 0.8, x, y + size);
  ctx.bezierCurveTo(x, y + size * 0.8, x + size / 2, y + size * 0.6, x + size / 2, y + size * 0.3);
  ctx.bezierCurveTo(x + size / 2, y, x, y, x, y + size * 0.3);
  ctx.fill();
  ctx.globalAlpha = 1;
  ctx.restore();
}

// --- Background ---
function drawBackground() {
  // Sky gradient
  let grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, '#4a90d9');
  grad.addColorStop(0.15, '#7eb8e0');
  grad.addColorStop(0.3, '#b8d8f8');
  grad.addColorStop(0.4, '#e8f4ff');
  grad.addColorStop(1, '#dce8f4');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, H);

  // Distant mountains (parallax)
  let mOffset = scrollY * 0.05;
  ctx.fillStyle = '#a0b4cc';
  ctx.beginPath();
  ctx.moveTo(0, 120 - mOffset % 40);
  ctx.lineTo(80, 60 - mOffset % 40);
  ctx.lineTo(160, 100 - mOffset % 40);
  ctx.lineTo(260, 40 - mOffset % 40);
  ctx.lineTo(360, 90 - mOffset % 40);
  ctx.lineTo(440, 50 - mOffset % 40);
  ctx.lineTo(W, 80 - mOffset % 40);
  ctx.lineTo(W, 160);
  ctx.lineTo(0, 160);
  ctx.fill();

  // Snow layer
  ctx.fillStyle = '#e8f0fa';
  ctx.fillRect(0, 150, W, H - 150);

  // Slope texture ‚Äî subtle lines
  ctx.strokeStyle = 'rgba(180,200,220,0.3)';
  ctx.lineWidth = 1;
  for (let i = 0; i < 15; i++) {
    let ly = 200 + i * 50 - (scrollY * 0.3) % 50;
    ctx.beginPath();
    ctx.moveTo(0, ly);
    ctx.lineTo(W, ly + 20);
    ctx.stroke();
  }
}

// --- Question Zone ---
function drawLodge(y) {
  let lx = W / 2;
  let left = 10;
  let right = W - 10;
  let smokeTime = Date.now() / 1000;

  // ============ LEFT WING ‚Äî RENTALS SHOP ============
  let lwL = left;
  let lwR = lx - 30;
  let lwW = lwR - lwL;

  // Wall
  ctx.fillStyle = '#5d4037';
  ctx.fillRect(lwL, y + 30, lwW, 280);
  // Wood plank texture
  ctx.strokeStyle = '#4e342e';
  ctx.lineWidth = 0.8;
  for (let i = 0; i < 12; i++) {
    ctx.beginPath(); ctx.moveTo(lwL, y + 38 + i * 22); ctx.lineTo(lwR, y + 38 + i * 22); ctx.stroke();
  }
  // Vertical plank dividers
  for (let i = 1; i < 4; i++) {
    ctx.beginPath(); ctx.moveTo(lwL + i * (lwW / 4), y + 30); ctx.lineTo(lwL + i * (lwW / 4), y + 310); ctx.stroke();
  }

  // Left wing roof
  ctx.fillStyle = '#3e2723';
  ctx.beginPath();
  ctx.moveTo(lwL - 10, y + 30);
  ctx.lineTo(lwL + lwW / 2, y - 20);
  ctx.lineTo(lwR + 10, y + 30);
  ctx.closePath();
  ctx.fill();
  // Shingles
  ctx.strokeStyle = '#2c1e15';
  ctx.lineWidth = 0.8;
  for (let i = 0; i < 4; i++) {
    let ry = y - 10 + i * 10;
    let sp = (i + 1) / 4;
    ctx.beginPath();
    ctx.moveTo(lwL + lwW / 2 - sp * (lwW / 2 + 10), ry);
    ctx.lineTo(lwL + lwW / 2 + sp * (lwW / 2 + 10), ry);
    ctx.stroke();
  }
  // Snow on left roof
  ctx.fillStyle = '#e8f0fa';
  ctx.beginPath();
  ctx.moveTo(lwL - 6, y + 32);
  ctx.lineTo(lwL + lwW / 2, y - 14);
  ctx.lineTo(lwR + 6, y + 32);
  ctx.lineTo(lwR, y + 36);
  ctx.quadraticCurveTo(lwR - 20, y + 38, lwR - 40, y + 33);
  ctx.quadraticCurveTo(lwL + lwW / 2, y + 26, lwL + 30, y + 34);
  ctx.quadraticCurveTo(lwL + 10, y + 38, lwL - 2, y + 35);
  ctx.closePath();
  ctx.fill();

  // Rentals sign ‚Äî large, on wall
  ctx.fillStyle = '#1565c0';
  ctx.beginPath();
  roundRect(ctx, lwL + 12, y + 38, lwW - 24, 34, 6);
  ctx.fill();
  ctx.strokeStyle = '#e8f0fa';
  ctx.lineWidth = 2;
  ctx.beginPath();
  roundRect(ctx, lwL + 15, y + 41, lwW - 30, 28, 4);
  ctx.stroke();
  ctx.fillStyle = 'white';
  ctx.font = "bold 18px 'Bangers', cursive";
  ctx.textAlign = 'center';
  ctx.fillText('üéø  RENTALS  üéø', lwL + lwW / 2, y + 62);

  // Rentals window
  ctx.fillStyle = 'rgba(255,249,196,0.25)';
  ctx.fillRect(lwL + 20, y + 82, lwW - 40, 40);
  ctx.fillStyle = '#fff9c4';
  ctx.fillRect(lwL + 24, y + 86, lwW - 48, 32);
  ctx.strokeStyle = '#4e342e';
  ctx.lineWidth = 2;
  ctx.strokeRect(lwL + 24, y + 86, lwW - 48, 32);
  ctx.beginPath(); ctx.moveTo(lwL + lwW / 2, y + 86); ctx.lineTo(lwL + lwW / 2, y + 118); ctx.stroke();
  // Shutters
  ctx.fillStyle = '#1565c0';
  ctx.fillRect(lwL + 18, y + 84, 6, 36);
  ctx.fillRect(lwR - 24, y + 84, 6, 36);

  // Skis in rack outside
  let rackX = lwL + 16;
  ctx.fillStyle = '#5d4037';
  ctx.fillRect(rackX, y + 128, 4, 40);
  ctx.fillRect(rackX + 50, y + 128, 4, 40);
  ctx.fillRect(rackX, y + 132, 54, 4);
  // Skis in rack
  let skiColors = ['#d35400', '#2980b9', '#e74c3c', '#27ae60'];
  for (let i = 0; i < 4; i++) {
    ctx.fillStyle = skiColors[i];
    ctx.fillRect(rackX + 8 + i * 12, y + 100, 3, 36);
    // Curved tip
    ctx.beginPath();
    ctx.moveTo(rackX + 8 + i * 12, y + 100);
    ctx.quadraticCurveTo(rackX + 9.5 + i * 12, y + 94, rackX + 12 + i * 12, y + 93);
    ctx.lineWidth = 2.5;
    ctx.strokeStyle = skiColors[i];
    ctx.stroke();
  }

  // ============ RIGHT WING ‚Äî HOT COCOA SHOP ============
  let rwL = lx + 30;
  let rwR = right;
  let rwW = rwR - rwL;

  // Wall
  ctx.fillStyle = '#6d4c41';
  ctx.fillRect(rwL, y + 30, rwW, 280);
  // Wood plank texture
  ctx.strokeStyle = '#5d4037';
  ctx.lineWidth = 0.8;
  for (let i = 0; i < 12; i++) {
    ctx.beginPath(); ctx.moveTo(rwL, y + 38 + i * 22); ctx.lineTo(rwR, y + 38 + i * 22); ctx.stroke();
  }
  for (let i = 1; i < 4; i++) {
    ctx.beginPath(); ctx.moveTo(rwL + i * (rwW / 4), y + 30); ctx.lineTo(rwL + i * (rwW / 4), y + 310); ctx.stroke();
  }

  // Right wing roof
  ctx.fillStyle = '#4e342e';
  ctx.beginPath();
  ctx.moveTo(rwL - 10, y + 30);
  ctx.lineTo(rwL + rwW / 2, y - 20);
  ctx.lineTo(rwR + 10, y + 30);
  ctx.closePath();
  ctx.fill();
  ctx.strokeStyle = '#3a2518';
  ctx.lineWidth = 0.8;
  for (let i = 0; i < 4; i++) {
    let ry = y - 10 + i * 10;
    let sp = (i + 1) / 4;
    ctx.beginPath();
    ctx.moveTo(rwL + rwW / 2 - sp * (rwW / 2 + 10), ry);
    ctx.lineTo(rwL + rwW / 2 + sp * (rwW / 2 + 10), ry);
    ctx.stroke();
  }
  // Snow on right roof
  ctx.fillStyle = '#e8f0fa';
  ctx.beginPath();
  ctx.moveTo(rwL - 6, y + 32);
  ctx.lineTo(rwL + rwW / 2, y - 14);
  ctx.lineTo(rwR + 6, y + 32);
  ctx.lineTo(rwR, y + 36);
  ctx.quadraticCurveTo(rwR - 20, y + 39, rwR - 50, y + 33);
  ctx.quadraticCurveTo(rwL + rwW / 2, y + 26, rwL + 30, y + 35);
  ctx.quadraticCurveTo(rwL + 10, y + 38, rwL - 2, y + 35);
  ctx.closePath();
  ctx.fill();

  // Chimney on right wing
  ctx.fillStyle = '#795548';
  ctx.fillRect(rwR - 40, y - 16, 16, 40);
  ctx.fillStyle = '#5d4037';
  ctx.fillRect(rwR - 44, y - 19, 24, 5);
  ctx.fillStyle = '#e8f0fa';
  ctx.beginPath();
  ctx.moveTo(rwR - 46, y - 18);
  ctx.quadraticCurveTo(rwR - 32, y - 26, rwR - 18, y - 18);
  ctx.quadraticCurveTo(rwR - 24, y - 15, rwR - 32, y - 16);
  ctx.quadraticCurveTo(rwR - 40, y - 15, rwR - 46, y - 18);
  ctx.fill();
  // Smoke
  ctx.fillStyle = 'rgba(200,200,200,0.3)';
  for (let i = 0; i < 5; i++) {
    let sy = y - 24 - i * 14 + Math.sin(smokeTime + i) * 3;
    let sx = rwR - 32 + Math.sin(smokeTime * 0.7 + i * 2) * 6;
    ctx.beginPath(); ctx.arc(sx, sy, 4 + i * 2.5, 0, Math.PI * 2); ctx.fill();
  }

  // Hot Cocoa sign ‚Äî large, on wall
  ctx.fillStyle = '#b71c1c';
  ctx.beginPath();
  roundRect(ctx, rwL + 10, y + 38, rwW - 20, 34, 6);
  ctx.fill();
  ctx.strokeStyle = '#e8f0fa';
  ctx.lineWidth = 2;
  ctx.beginPath();
  roundRect(ctx, rwL + 13, y + 41, rwW - 26, 28, 4);
  ctx.stroke();
  ctx.fillStyle = 'white';
  ctx.font = "bold 17px 'Bangers', cursive";
  ctx.textAlign = 'center';
  ctx.fillText('‚òï  HOT COCOA  ‚òï', rwL + rwW / 2, y + 62);

  // Cocoa shop window
  ctx.fillStyle = 'rgba(255,249,196,0.25)';
  ctx.fillRect(rwL + 18, y + 82, rwW - 36, 40);
  ctx.fillStyle = '#fff9c4';
  ctx.fillRect(rwL + 22, y + 86, rwW - 44, 32);
  ctx.strokeStyle = '#4e342e';
  ctx.lineWidth = 2;
  ctx.strokeRect(rwL + 22, y + 86, rwW - 44, 32);
  ctx.beginPath(); ctx.moveTo(rwL + rwW / 2, y + 86); ctx.lineTo(rwL + rwW / 2, y + 118); ctx.stroke();
  ctx.fillStyle = '#b71c1c';
  ctx.fillRect(rwL + 16, y + 84, 6, 36);
  ctx.fillRect(rwR - 22, y + 84, 6, 36);

  // Bench outside cocoa shop
  ctx.fillStyle = '#5d4037';
  ctx.fillRect(rwL + 14, y + 142, 3, 14);
  ctx.fillRect(rwL + 54, y + 142, 3, 14);
  ctx.fillStyle = '#6d4c41';
  ctx.fillRect(rwL + 10, y + 138, 52, 5);
  ctx.fillRect(rwL + 10, y + 130, 52, 4);

  // ============ CENTER ‚Äî MAIN LODGE ============
  let cwL = lx - 55;
  let cwR = lx + 55;
  let cwW = 110;

  // Wall ‚Äî taller, sits in front
  ctx.fillStyle = '#5d4037';
  ctx.fillRect(cwL, y + 10, cwW, 300);
  // Stone base
  ctx.fillStyle = '#78909c';
  ctx.fillRect(cwL, y + 180, cwW, 130);
  // Stone texture (clipped to center building)
  ctx.save();
  ctx.beginPath();
  ctx.rect(cwL, y + 180, cwW, 130);
  ctx.clip();
  ctx.strokeStyle = '#607d8b';
  ctx.lineWidth = 1;
  for (let row = 0; row < 5; row++) {
    let sy = y + 185 + row * 24;
    let offset = (row % 2) * 16;
    for (let col = -1; col < 5; col++) {
      ctx.strokeRect(cwL + offset + col * 28, sy, 28, 24);
    }
  }
  ctx.restore();
  // Wood upper
  ctx.strokeStyle = '#4e342e';
  ctx.lineWidth = 0.8;
  for (let i = 0; i < 8; i++) {
    ctx.beginPath(); ctx.moveTo(cwL, y + 18 + i * 20); ctx.lineTo(cwR, y + 18 + i * 20); ctx.stroke();
  }

  // Center roof ‚Äî taller peak
  ctx.fillStyle = '#3e2723';
  ctx.beginPath();
  ctx.moveTo(cwL - 16, y + 10);
  ctx.lineTo(lx, y - 60);
  ctx.lineTo(cwR + 16, y + 10);
  ctx.closePath();
  ctx.fill();
  ctx.strokeStyle = '#2c1e15';
  ctx.lineWidth = 0.8;
  for (let i = 0; i < 5; i++) {
    let ry = y - 48 + i * 12;
    let sp = (i + 1) / 5;
    ctx.beginPath();
    ctx.moveTo(lx - sp * (cwW / 2 + 16), ry);
    ctx.lineTo(lx + sp * (cwW / 2 + 16), ry);
    ctx.stroke();
  }
  // Snow on center roof
  ctx.fillStyle = '#e8f0fa';
  ctx.beginPath();
  ctx.moveTo(cwL - 12, y + 12);
  ctx.lineTo(lx, y - 54);
  ctx.lineTo(cwR + 12, y + 12);
  ctx.lineTo(cwR + 6, y + 18);
  ctx.quadraticCurveTo(cwR - 10, y + 22, lx + 15, y + 15);
  ctx.quadraticCurveTo(lx, y + 10, lx - 15, y + 16);
  ctx.quadraticCurveTo(cwL + 10, y + 22, cwL - 8, y + 17);
  ctx.closePath();
  ctx.fill();

  // === STEEZE CITY SIGN ‚Äî centered on main building ===
  ctx.fillStyle = '#3e2723';
  ctx.beginPath();
  roundRect(ctx, lx - 80, y - 22, 160, 32, 6);
  ctx.fill();
  ctx.strokeStyle = '#fdd835';
  ctx.lineWidth = 2;
  ctx.beginPath();
  roundRect(ctx, lx - 76, y - 18, 152, 24, 4);
  ctx.stroke();
  ctx.fillStyle = '#fdd835';
  ctx.font = "bold 20px 'Bangers', cursive";
  ctx.textAlign = 'center';
  ctx.fillText('‚õ∑  STEEZE CITY  ‚õ∑', lx, y + 1);

  // Double doors
  ctx.fillStyle = '#4e342e';
  ctx.fillRect(lx - 20, y + 40, 40, 65);
  ctx.fillStyle = '#3e2723';
  ctx.fillRect(lx - 16, y + 44, 14, 24);
  ctx.fillRect(lx + 2, y + 44, 14, 24);
  ctx.fillRect(lx - 16, y + 72, 14, 28);
  ctx.fillRect(lx + 2, y + 72, 14, 28);
  ctx.fillStyle = '#fdd835';
  ctx.beginPath(); ctx.arc(lx - 3, y + 78, 2, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(lx + 3, y + 78, 2, 0, Math.PI * 2); ctx.fill();

  // Transom window above door
  ctx.fillStyle = '#fff9c4';
  ctx.beginPath();
  ctx.moveTo(lx - 18, y + 36);
  ctx.quadraticCurveTo(lx, y + 24, lx + 18, y + 36);
  ctx.lineTo(lx - 18, y + 36);
  ctx.fill();
  ctx.strokeStyle = '#4e342e';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Side windows on center
  let cwWins = [cwL + 8, cwR - 28];
  for (let wx of cwWins) {
    ctx.fillStyle = 'rgba(255,249,196,0.2)';
    ctx.fillRect(wx - 2, y + 42, 24, 32);
    ctx.fillStyle = '#fff9c4';
    ctx.fillRect(wx, y + 44, 20, 28);
    ctx.strokeStyle = '#4e342e';
    ctx.lineWidth = 1.5;
    ctx.strokeRect(wx, y + 44, 20, 28);
    ctx.beginPath(); ctx.moveTo(wx + 10, y + 44); ctx.lineTo(wx + 10, y + 72); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(wx, y + 58); ctx.lineTo(wx + 20, y + 58); ctx.stroke();
  }

  // ============ PORCH ‚Äî spans full width ============
  let porchY = y + 170;

  // Porch floor
  ctx.fillStyle = '#6d4c41';
  ctx.fillRect(left, porchY, right - left, 14);
  // Floor boards
  ctx.strokeStyle = '#5d4037';
  ctx.lineWidth = 0.8;
  for (let i = 0; i < 20; i++) {
    ctx.beginPath();
    ctx.moveTo(left + i * 24, porchY);
    ctx.lineTo(left + i * 24, porchY + 14);
    ctx.stroke();
  }

  // Porch roof / awning
  ctx.fillStyle = '#4e342e';
  ctx.fillRect(left - 5, porchY - 6, right - left + 10, 8);
  // Snow on porch roof edge
  ctx.fillStyle = '#e8f0fa';
  ctx.beginPath();
  ctx.moveTo(left - 5, porchY - 6);
  for (let i = 0; i <= 10; i++) {
    let px = left - 5 + i * ((right - left + 10) / 10);
    let py = porchY - 6 + Math.sin(i * 1.3) * 3 - 4;
    ctx.quadraticCurveTo(px - 10, py - 2, px, py);
  }
  ctx.lineTo(right + 5, porchY - 6);
  ctx.closePath();
  ctx.fill();

  // Porch support posts
  let postPositions = [left + 15, left + 80, lx - 30, lx + 30, right - 80, right - 15];
  for (let px of postPositions) {
    ctx.fillStyle = '#5d4037';
    ctx.fillRect(px - 3, porchY - 6, 6, -50);
    // Post cap
    ctx.fillRect(px - 5, porchY - 56, 10, 4);
    // Post base
    ctx.fillRect(px - 5, porchY, 10, 4);
  }

  // Railing between posts
  ctx.strokeStyle = '#5d4037';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(left + 15, porchY - 20);
  ctx.lineTo(right - 15, porchY - 20);
  ctx.stroke();
  // Railing balusters
  ctx.lineWidth = 1.5;
  for (let bx = left + 20; bx < right - 15; bx += 12) {
    // Skip door area
    if (bx > lx - 24 && bx < lx + 24) continue;
    ctx.beginPath();
    ctx.moveTo(bx, porchY - 2);
    ctx.lineTo(bx, porchY - 20);
    ctx.stroke();
  }

  // Porch steps (center)
  ctx.fillStyle = '#6d4c41';
  for (let i = 0; i < 3; i++) {
    ctx.fillRect(lx - 24 + i * 2, porchY + 12 + i * 8, 48 - i * 4, 8);
    ctx.strokeStyle = '#5d4037';
    ctx.lineWidth = 0.8;
    ctx.strokeRect(lx - 24 + i * 2, porchY + 12 + i * 8, 48 - i * 4, 8);
  }

  // ============ STRING LIGHTS across porch ============
  ctx.strokeStyle = '#444';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(left + 15, porchY - 50);
  ctx.quadraticCurveTo(lx, porchY - 40, right - 15, porchY - 50);
  ctx.stroke();
  let bulbColors = ['#e74c3c', '#f1c40f', '#2ecc71', '#3498db', '#e84393', '#f39c12'];
  for (let i = 0; i < 14; i++) {
    let t = (i + 0.5) / 14;
    let bx = left + 15 + t * (right - left - 30);
    let by = porchY - 50 + Math.sin(t * Math.PI) * 10;
    ctx.fillStyle = bulbColors[i % bulbColors.length];
    ctx.beginPath(); ctx.arc(bx, by + 2, 2.5, 0, Math.PI * 2); ctx.fill();
    ctx.globalAlpha = 0.35;
    ctx.beginPath(); ctx.arc(bx, by + 2, 5, 0, Math.PI * 2); ctx.fill();
    ctx.globalAlpha = 1;
  }

  // ============ DETAILS ============
  // Lanterns on porch posts
  let lanternPosts = [left + 15, right - 15];
  for (let lpx of lanternPosts) {
    ctx.fillStyle = '#333';
    ctx.fillRect(lpx - 4, porchY - 48, 8, 2);
    ctx.fillRect(lpx - 3, porchY - 46, 6, 10);
    ctx.fillStyle = '#f39c12';
    ctx.globalAlpha = 0.8;
    ctx.fillRect(lpx - 2, porchY - 44, 4, 6);
    ctx.globalAlpha = 0.3;
    ctx.beginPath(); ctx.arc(lpx, porchY - 41, 8, 0, Math.PI * 2); ctx.fill();
    ctx.globalAlpha = 1;
  }

  // Welcome mat
  ctx.fillStyle = '#8d6e63';
  ctx.fillRect(lx - 18, porchY + 2, 36, 8);
  ctx.fillStyle = '#6d4c41';
  ctx.fillRect(lx - 16, porchY + 3, 32, 6);
}

function drawQuestionZone() {
  let zoneScreenY = QUESTION_ZONE - scrollY;
  if (zoneScreenY > H + 200 || zoneScreenY < -600) return;

  // Position text and gates relative to zoneScreenY but shifted so visible when stopped
  // When stopped, scrollY = QUESTION_ZONE - 60, so zoneScreenY = 60
  // We want text well below that ‚Äî offset everything by +160 from zoneScreenY
  let bannerY = zoneScreenY + 140;
  let gateY = zoneScreenY + 240;
  let lodgeY = zoneScreenY + 360;

  // "Will you be my Valentine?" text on the snow
  ctx.save();
  ctx.fillStyle = var_pink;
  ctx.font = "bold 32px 'Bangers', cursive";
  ctx.textAlign = 'center';
  ctx.shadowColor = 'rgba(232,67,147,0.5)';
  ctx.shadowBlur = 15;
  ctx.fillText('Will you be my', W / 2, bannerY);
  ctx.fillText('Valentine? üíï', W / 2, bannerY + 40);
  ctx.shadowBlur = 0;
  ctx.restore();

  // Arrows on snow
  ctx.fillStyle = 'rgba(232,67,147,0.3)';
  ctx.font = "40px sans-serif";
  ctx.fillText('‚¨á', 120, gateY - 20);
  ctx.fillText('‚¨á', 360, gateY - 20);

  // YES gate (left side)
  ctx.fillStyle = '#27ae60';
  ctx.beginPath();
  roundRect(ctx, 40, gateY, 160, 60, 12);
  ctx.fill();
  ctx.strokeStyle = '#1e8449';
  ctx.lineWidth = 3;
  ctx.stroke();
  ctx.fillStyle = 'white';
  ctx.font = "bold 32px 'Bangers', cursive";
  ctx.textAlign = 'center';
  ctx.fillText('YES üíú', 120, gateY + 40);

  // NO gate (right side)
  ctx.fillStyle = '#c0392b';
  ctx.beginPath();
  roundRect(ctx, 280, gateY, 160, 60, 12);
  ctx.fill();
  ctx.strokeStyle = '#922b21';
  ctx.lineWidth = 3;
  ctx.stroke();
  ctx.fillStyle = 'white';
  ctx.fillText('NO üíî', 360, gateY + 40);

  // Lodge at the bottom
  drawLodge(lodgeY);
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
}

// --- Lift animation ---
let liftStartTime = 0;
function drawLift() {
  // Cable
  ctx.strokeStyle = '#555';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(W / 2, -20);
  ctx.lineTo(W / 2, H + 20);
  ctx.stroke();

  // Chair
  let chairY = H - liftY;

  // Cable attachment
  ctx.strokeStyle = '#444';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(W / 2, chairY - 30);
  ctx.lineTo(W / 2, chairY);
  ctx.stroke();

  // Seat bar
  ctx.fillStyle = '#333';
  ctx.fillRect(W / 2 - 20, chairY, 40, 4);

  // Seat
  ctx.fillStyle = '#2c3e50';
  ctx.fillRect(W / 2 - 18, chairY + 4, 36, 8);

  // Player sitting on lift
  ctx.save();
  ctx.translate(W / 2, chairY - 2);

  // Legs dangling
  ctx.fillStyle = '#6d4c28';
  ctx.fillRect(-6, 12, 5, 10);
  ctx.fillRect(1, 12, 5, 10);

  // Torso
  ctx.fillStyle = '#0d9488';
  ctx.fillRect(-8, 0, 16, 14);
  ctx.fillStyle = '#14b8a6';
  ctx.fillRect(-6, 2, 12, 10);

  // Head
  ctx.fillStyle = '#ffeaa7';
  ctx.beginPath(); ctx.arc(0, -6, 7, 0, Math.PI * 2); ctx.fill();
  // Helmet
  ctx.fillStyle = '#27ae60';
  ctx.beginPath(); ctx.arc(0, -8, 8, Math.PI, 0); ctx.fill();
  ctx.fillRect(-8, -8, 16, 3);

  ctx.restore();

  // Towers going by
  for (let i = 0; i < 3; i++) {
    let towerY = 200 + i * 300 - (liftY * 0.5) % 300;
    ctx.fillStyle = '#555';
    ctx.fillRect(W / 2 - 4, towerY - 40, 8, 80);
    ctx.fillRect(W / 2 - 20, towerY - 40, 40, 6);
  }
}

// --- Main Game Loop ---
let lastTime = 0;
function gameLoop(timestamp) {
  let dt = Math.min((timestamp - lastTime) / 16.67, 3);
  lastTime = timestamp;

  if (state === 'playing') updatePlaying(dt);
  else if (state === 'choosing') updateChoosing(dt);
  else if (state === 'lift') updateLift(dt);
  else if (state === 'rescue') updateRescue(dt);

  draw();

  if (state !== 'menu') requestAnimationFrame(gameLoop);
}

function updatePlaying(dt) {
  // Gravity / auto-scroll
  player.speed = Math.min(player.speed + 0.015 * dt, player.maxSpeed);

  if (crashTimer > 0) {
    crashTimer -= dt;
    player.speed = 0;
    if (crashTimer <= 0) {
      crashTimer = 0;
      player.speed = 1;
    }
    return;
  }

  scrollY += player.speed * dt;

  // Steer
  let accel = 0.35;
  let friction = 0.88;
  if (touchActive && (touchDX !== 0)) {
    // Analog touch ‚Äî scale force by distance, capped
    let force = Math.max(-1, Math.min(1, touchDX / 80));
    player.vx += force * accel * 2.2 * dt;
    player.tilt = Math.max(-1, Math.min(1, force));
  } else if (keys['ArrowLeft']) { player.vx -= accel * dt; player.tilt = Math.max(player.tilt - 0.1 * dt, -1); }
  else if (keys['ArrowRight']) { player.vx += accel * dt; player.tilt = Math.min(player.tilt + 0.1 * dt, 1); }
  else { player.tilt *= 0.9; }

  player.vx *= friction;
  player.x += player.vx * dt;
  player.x = Math.max(20, Math.min(W - 20, player.x));

  // Snow spray when turning
  if (Math.abs(player.vx) > 1) {
    spawnSpray(player.x, player.y, player.vx > 0 ? -1 : 1);
  }

  // Trail
  player.trail.push({ x: player.x, y: scrollY + player.y });
  if (player.trail.length > 40) player.trail.shift();

  // Collision check
  for (let ob of obstacles) {
    if (ob.hit) continue;
    let screenOY = ob.y - scrollY;
    let dx = player.x - ob.x;
    let dy = player.y - screenOY;
    let dist = Math.sqrt(dx * dx + dy * dy);
    let hitRadius = ob.type === 'tree' ? 18 : ob.type === 'rock' ? 16 : 16;
    if (dist < hitRadius) {
      ob.hit = true;
      crashTimer = 30;
      player.speed = 0;
      player.vx = 0;
      health--;
      spawnCrash(player.x, player.y);
      if (health <= 0) {
        state = 'wipeout';
        showWipeout();
        return;
      }
    }
  }

  // Check if reached question zone ‚Äî slow down and stop
  if (scrollY > QUESTION_ZONE - 300) {
    player.speed = Math.max(player.speed - 0.08 * dt, 0.8);
  }
  if (scrollY >= QUESTION_ZONE - 60) {
    // Stop scrolling, switch to choosing state
    scrollY = QUESTION_ZONE - 60;
    player.speed = 0;
    state = 'choosing';
  }
}

function updateChoosing(dt) {
  // Free movement with all arrow keys ‚Äî no scrolling
  let accel = 0.4;
  let friction = 0.88;
  let yAccel = 0.35;
  let yFriction = 0.88;

  if (!player.vy) player.vy = 0;

  if (touchActive && (touchDX !== 0 || touchDY !== 0)) {
    let forceX = Math.max(-1, Math.min(1, touchDX / 80));
    let forceY = Math.max(-1, Math.min(1, touchDY / 80));
    player.vx += forceX * accel * 2.2 * dt;
    player.vy += forceY * yAccel * 2.2 * dt;
    player.tilt = Math.max(-1, Math.min(1, forceX));
  } else {
    if (keys['ArrowLeft']) { player.vx -= accel * dt; player.tilt = Math.max(player.tilt - 0.1 * dt, -1); }
    else if (keys['ArrowRight']) { player.vx += accel * dt; player.tilt = Math.min(player.tilt + 0.1 * dt, 1); }
    else { player.tilt *= 0.9; }

    if (keys['ArrowDown']) { player.vy += yAccel * dt; }
    else if (keys['ArrowUp']) { player.vy -= yAccel * dt; }
  }

  player.vx *= friction;
  player.vy *= yFriction;
  player.x += player.vx * dt;
  player.y += player.vy * dt;
  player.x = Math.max(20, Math.min(W - 20, player.x));
  player.y = Math.max(100, Math.min(H - 40, player.y));

  // Snow spray when moving
  if (Math.abs(player.vx) > 1 || Math.abs(player.vy) > 1) {
    spawnSpray(player.x, player.y, player.vx > 0 ? -1 : 1);
  }

  // Check if player entered YES or NO gate
  // Gates are drawn at: YES = (40..200, gateY..gateY+60), NO = (280..440, gateY..gateY+60)
  let gateScreenY = (QUESTION_ZONE - scrollY) + 240;
  let px = player.x;
  let py = player.y;

  // Desktop: steer into gates to select. Mobile: tap only (handled in touchstart).
  if (!isMobile && py > gateScreenY && py < gateScreenY + 60) {
    if (px > 40 && px < 200) {
      state = 'yes';
      spawnHearts(W / 2, H / 2);
      showYes();
    } else if (px > 280 && px < 440) {
      state = 'no';
      showNo();
    }
  }
}

function updateLift(dt) {
  liftY += 3 * dt;
  if (liftY > 800) {
    liftY = 0;
    initGame();
  }
}

let rescueX = 0;
let rescuePhase = 0; // 0=approaching, 1=loading, 2=driving away
let rescueTimer = 0;
let rescuePlayerOnBoard = false;

function showWipeout() {
  overlayTitle.textContent = 'üí• WIPEOUT! üí•';
  overlayText.innerHTML = "Tough run!<br><br><span style='font-size:14px;opacity:0.7'>Press any key or click to call ski patrol</span>";
  setTimeout(() => {
    overlay.classList.add('visible');
    let callPatrol = () => {
      overlay.classList.remove('visible');
      window.removeEventListener('keydown', callPatrol);
      overlay.removeEventListener('click', callPatrol);
      startRescue();
    };
    setTimeout(() => {
      window.addEventListener('keydown', callPatrol, { once: true });
      overlay.addEventListener('click', callPatrol, { once: true });
    }, 600);
  }, 500);
}

function startRescue() {
  state = 'rescue';
  rescueX = -120;
  rescuePhase = 0;
  rescueTimer = 0;
  rescuePlayerOnBoard = false;
}

function updateRescue(dt) {
  rescueTimer += dt;
  let targetX = player.x - 30;

  if (rescuePhase === 0) {
    // Snowmobile approaching from left
    rescueX += 3 * dt;
    if (rescueX >= targetX) {
      rescueX = targetX;
      rescuePhase = 1;
      rescueTimer = 0;
    }
  } else if (rescuePhase === 1) {
    // Loading pause ‚Äî player hops on
    if (rescueTimer > 25) {
      rescuePlayerOnBoard = true;
    }
    if (rescueTimer > 50) {
      rescuePhase = 2;
      rescueTimer = 0;
    }
  } else if (rescuePhase === 2) {
    // Drive off to the right
    rescueX += 4 * dt;
    if (rescueX > W + 140) {
      initGame();
    }
  }
}

function drawSnowmobile(x, y) {
  ctx.save();
  ctx.translate(x, y);

  // Track/ski base
  ctx.fillStyle = '#1a1a1a';
  ctx.beginPath();
  ctx.moveTo(-20, 12);
  ctx.lineTo(35, 12);
  ctx.quadraticCurveTo(42, 12, 42, 8);
  ctx.lineTo(42, 6);
  ctx.lineTo(-25, 6);
  ctx.quadraticCurveTo(-28, 8, -25, 12);
  ctx.closePath();
  ctx.fill();

  // Track treads
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 1;
  for (let i = -18; i < 34; i += 5) {
    ctx.beginPath(); ctx.moveTo(i, 7); ctx.lineTo(i, 12); ctx.stroke();
  }

  // Front ski
  ctx.fillStyle = '#555';
  ctx.beginPath();
  ctx.moveTo(38, 10);
  ctx.lineTo(55, 8);
  ctx.quadraticCurveTo(60, 6, 58, 4);
  ctx.lineTo(38, 6);
  ctx.closePath();
  ctx.fill();

  // Body/cowling
  ctx.fillStyle = '#c0392b';
  ctx.beginPath();
  ctx.moveTo(-15, 4);
  ctx.lineTo(30, 4);
  ctx.quadraticCurveTo(40, 2, 42, -4);
  ctx.lineTo(40, -8);
  ctx.lineTo(25, -8);
  ctx.lineTo(20, -2);
  ctx.lineTo(-10, -2);
  ctx.lineTo(-15, 4);
  ctx.closePath();
  ctx.fill();

  // Seat
  ctx.fillStyle = '#2c3e50';
  ctx.fillRect(-15, -6, 30, 5);
  ctx.fillStyle = '#34495e';
  ctx.fillRect(-13, -8, 26, 3);

  // Windshield
  ctx.fillStyle = 'rgba(135,206,250,0.6)';
  ctx.beginPath();
  ctx.moveTo(22, -8);
  ctx.lineTo(28, -18);
  ctx.lineTo(36, -18);
  ctx.lineTo(38, -8);
  ctx.closePath();
  ctx.fill();
  ctx.strokeStyle = '#555';
  ctx.lineWidth = 1;
  ctx.stroke();

  // Headlight
  ctx.fillStyle = '#f1c40f';
  ctx.beginPath(); ctx.arc(42, -4, 3, 0, Math.PI * 2); ctx.fill();

  // Red cross / patrol marking
  ctx.fillStyle = 'white';
  ctx.fillRect(5, -1, 12, 4);
  ctx.fillStyle = '#c0392b';
  ctx.fillRect(8, -1, 6, 4);
  ctx.fillRect(8, -1, 6, 4);
  // Cross
  ctx.fillStyle = 'white';
  ctx.fillRect(9.5, -0.5, 3, 3);
  ctx.fillRect(9, 0, 4, 2);

  // Snow spray from treads (when moving)
  if (rescuePhase !== 1) {
    ctx.fillStyle = 'rgba(232,240,250,0.6)';
    for (let i = 0; i < 3; i++) {
      let sx = -22 - Math.random() * 10;
      let sy = 8 + Math.random() * 6;
      ctx.beginPath(); ctx.arc(sx, sy, 2 + Math.random() * 3, 0, Math.PI * 2); ctx.fill();
    }
  }

  ctx.restore();
}

function drawPatrolDriver(x, y) {
  ctx.save();
  ctx.translate(x, y);

  // Legs
  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(-4, 0, 4, 8);
  ctx.fillRect(2, 0, 4, 8);

  // Torso ‚Äî red patrol jacket
  ctx.fillStyle = '#e74c3c';
  ctx.fillRect(-6, -12, 12, 13);
  ctx.fillStyle = '#c0392b';
  ctx.fillRect(-5, -10, 10, 9);

  // White cross on back
  ctx.fillStyle = 'white';
  ctx.fillRect(-2, -9, 4, 7);
  ctx.fillRect(-4, -7, 8, 3);

  // Head
  ctx.fillStyle = '#ffeaa7';
  ctx.beginPath(); ctx.arc(0, -18, 6, 0, Math.PI * 2); ctx.fill();

  // Red helmet
  ctx.fillStyle = '#c0392b';
  ctx.beginPath(); ctx.arc(0, -20, 7, Math.PI, 0); ctx.fill();
  ctx.fillRect(-7, -20, 14, 3);

  // Goggles
  ctx.fillStyle = '#f39c12';
  ctx.fillRect(-4, -19, 3, 2.5);
  ctx.fillRect(1, -19, 3, 2.5);

  ctx.restore();
}

function drawRescuePlayerOnSled(x, y) {
  // Player sitting/slumped on the back of the snowmobile
  ctx.save();
  ctx.translate(x, y);

  // Legs dangling
  ctx.fillStyle = '#6d4c28';
  ctx.fillRect(-4, 0, 4, 7);
  ctx.fillRect(2, 0, 4, 7);

  // Torso ‚Äî slouched
  ctx.fillStyle = '#0d9488';
  ctx.fillRect(-6, -10, 12, 12);
  ctx.fillStyle = '#14b8a6';
  ctx.fillRect(-5, -8, 10, 8);

  // Head ‚Äî tilted (dazed)
  ctx.save();
  ctx.rotate(0.2);
  ctx.fillStyle = '#ffeaa7';
  ctx.beginPath(); ctx.arc(0, -16, 6, 0, Math.PI * 2); ctx.fill();
  // Green helmet
  ctx.fillStyle = '#27ae60';
  ctx.beginPath(); ctx.arc(0, -18, 7, Math.PI, 0); ctx.fill();
  ctx.fillRect(-7, -18, 14, 3);
  ctx.restore();

  // Dizzy stars
  let t = Date.now() / 300;
  ctx.fillStyle = '#f1c40f';
  ctx.font = '10px sans-serif';
  ctx.fillText('‚ú¶', -8 + Math.sin(t) * 4, -24 + Math.cos(t) * 2);
  ctx.fillText('‚ú¶', 6 + Math.cos(t) * 4, -22 + Math.sin(t + 1) * 2);
  ctx.fillText('‚ú¶', -2 + Math.sin(t + 2) * 3, -28 + Math.cos(t + 2) * 2);

  ctx.restore();
}

function showYes() {
  overlayTitle.textContent = 'üíñ Huzzah! üíñ';
  overlayText.innerHTML = "Heck yeah, I'm stoked! I love you :)";
  setTimeout(() => overlay.classList.add('visible'), 500);
}

function showNo() {
  noCount++;
  if (noCount === 1) {
    overlayTitle.textContent = 'üö° Back Up You Go...';
    overlayText.innerHTML = "Hmm okay, maybe reconsider on the ride up?";
    setTimeout(() => {
      overlay.classList.add('visible');
      setTimeout(() => {
        overlay.classList.remove('visible');
        state = 'lift';
        liftY = 0;
      }, 2500);
    }, 300);
  } else if (noCount === 2) {
    overlayTitle.textContent = 'üö° One More Ride...';
    overlayText.innerHTML = "Maybe another run to think it through ü§û";
    setTimeout(() => {
      overlay.classList.add('visible');
      setTimeout(() => {
        overlay.classList.remove('visible');
        state = 'lift';
        liftY = 0;
      }, 2500);
    }, 300);
  } else {
    overlayTitle.textContent = 'üíî';
    overlayText.innerHTML = "Ok, I guess that was the last run :(";
    setTimeout(() => overlay.classList.add('visible'), 300);
  }
}

function draw() {
  ctx.clearRect(0, 0, W, H);
  drawBackground();

  // Draw trail
  if (player.trail && player.trail.length > 1) {
    ctx.strokeStyle = 'rgba(200,215,230,0.5)';
    ctx.lineWidth = 6;
    ctx.lineCap = 'round';
    ctx.beginPath();
    for (let i = 0; i < player.trail.length; i++) {
      let t = player.trail[i];
      let sy = t.y - scrollY;
      if (i === 0) ctx.moveTo(t.x, sy);
      else ctx.lineTo(t.x, sy);
    }
    ctx.stroke();
  }

  // Draw obstacles (clipped to slope area)
  ctx.save();
  ctx.beginPath();
  ctx.rect(0, 150, W, H - 150);
  ctx.clip();
  for (let ob of obstacles) {
    let sy = ob.y - scrollY;
    if (sy < -50 || sy > H + 50) continue;
    if (ob.hit) {
      ctx.globalAlpha = 0.3;
    }
    if (ob.type === 'tree') drawTree(ob.x, sy);
    else if (ob.type === 'rock') drawRock(ob.x, sy);
    else drawSkier(ob.x, sy);
    ctx.globalAlpha = 1;
  }
  ctx.restore();

  // Draw question zone
  drawQuestionZone();

  // Draw particles
  for (let i = particles.length - 1; i >= 0; i--) {
    let p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.05;
    p.life--;
    if (p.life <= 0) { particles.splice(i, 1); continue; }
    ctx.globalAlpha = p.life / p.maxLife;
    ctx.fillStyle = '#e8f4ff';
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  // Draw snowflakes
  for (let sf of snowflakes) {
    sf.y += sf.speed;
    sf.x += sf.drift;
    if (sf.y > H) { sf.y = -5; sf.x = Math.random() * W; }
    if (sf.x < 0) sf.x = W;
    if (sf.x > W) sf.x = 0;
    ctx.globalAlpha = 0.6;
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(sf.x, sf.y, sf.r, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  // Draw player
  if (state === 'playing' || state === 'choosing') {
    if (crashTimer > 0 && Math.floor(crashTimer) % 4 < 2) {
      // Blink on crash
    } else {
      drawPlayer(player.x, player.y, player.tilt);
    }
  }

  // Lift scene
  if (state === 'lift') {
    drawLift();
  }

  // Rescue scene
  if (state === 'rescue') {
    let snowmobileY = player.y + 4;
    // Draw the downed player (before they get picked up)
    if (!rescuePlayerOnBoard) {
      drawPlayer(player.x, player.y, 0.8); // slumped tilt
    }
    // Snowmobile + patrol driver
    drawSnowmobile(rescueX + 30, snowmobileY);
    drawPatrolDriver(rescueX + 30, snowmobileY - 10);
    // Player on back of snowmobile once loaded
    if (rescuePlayerOnBoard) {
      drawRescuePlayerOnSled(rescueX + 5, snowmobileY - 8);
    }
  }

  // Wipeout ‚Äî keep player visible on ground
  if (state === 'wipeout') {
    drawPlayer(player.x, player.y, 0.8);
  }

  // Hearts (yes ending)
  if (state === 'yes') {
    for (let i = hearts.length - 1; i >= 0; i--) {
      let h = hearts[i];
      h.x += h.vx;
      h.y += h.vy;
      h.vy += 0.01;
      h.life--;
      if (h.life <= 0) { hearts.splice(i, 1); continue; }
      let alpha = Math.min(1, h.life / 30);
      drawHeart(h.x, h.y, h.size, alpha);
    }
    // Keep spawning
    if (hearts.length < 20 && Math.random() < 0.3) {
      spawnHearts(W / 2, H / 2);
    }
  }

  // Choosing hint
  if (state === 'choosing') {
    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    roundRectFill(ctx, W / 2 - 120, 20, 240, 32, 10);
    ctx.fillStyle = 'white';
    ctx.font = "bold 14px 'Nunito', sans-serif";
    ctx.textAlign = 'center';
    let hintMsg = isMobile ? 'Tap YES or NO to answer!' : '‚¨Ö ‚¨Ü ‚¨á ‚û°  Steer to your answer!';
    ctx.fillText(hintMsg, W / 2, 42);
  }

  // HUD ‚Äî distance meter
  if (state === 'playing') {
    let progress = Math.min(scrollY / QUESTION_ZONE, 1);
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    roundRectFill(ctx, 16, 16, 140, 28, 8);
    ctx.fillStyle = 'rgba(232,67,147,0.6)';
    roundRectFill(ctx, 18, 18, Math.max(4, 136 * progress), 24, 6);
    ctx.fillStyle = 'white';
    ctx.font = "bold 13px 'Nunito', sans-serif";
    ctx.textAlign = 'left';
    ctx.fillText('üèÇ ' + Math.floor(progress * 100) + '%', 24, 35);

    // Health hearts
    for (let i = 0; i < 3; i++) {
      let hx = W - 40 - i * 36;
      let hy = 18;
      if (i < health) {
        // Full heart
        drawHUDHeart(hx, hy, 12, '#e84393', 1);
      } else {
        // Empty heart
        drawHUDHeart(hx, hy, 12, '#555', 0.5);
      }
    }
  }
}

function drawHUDHeart(x, y, size, color, alpha) {
  ctx.save();
  ctx.globalAlpha = alpha;
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(x, y + size * 0.3);
  ctx.bezierCurveTo(x, y, x - size / 2, y, x - size / 2, y + size * 0.3);
  ctx.bezierCurveTo(x - size / 2, y + size * 0.6, x, y + size * 0.8, x, y + size);
  ctx.bezierCurveTo(x, y + size * 0.8, x + size / 2, y + size * 0.6, x + size / 2, y + size * 0.3);
  ctx.bezierCurveTo(x + size / 2, y, x, y, x, y + size * 0.3);
  ctx.fill();
  ctx.restore();
}

function roundRectFill(ctx, x, y, w, h, r) {
  ctx.beginPath();
  roundRect(ctx, x, y, w, h, r);
  ctx.fill();
}

</script>
</body>
</html>
